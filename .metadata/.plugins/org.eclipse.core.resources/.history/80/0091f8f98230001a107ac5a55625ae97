package com.bridgelabz.felloship.operation;

import java.io.IOException;
import java.util.Date;
import java.util.List;
import java.util.Scanner;

import com.bridgelabz.felloship.control.StockControl;
import com.bridgelabz.felloship.model.StockUser;
import com.bridgelabz.felloship.model.TransactionLog;
import com.bridgelabz.felloship.model.stockmodel;
import com.bridgelabz.felloship.operation.StockOperations;
import com.fasterxml.jackson.core.JsonParseException;
import com.fasterxml.jackson.databind.JsonMappingException;

public class DataProcessing {
	static Scanner sc = new Scanner(System.in);

	public static void usermenu() throws JsonParseException, JsonMappingException, IOException {
		int key;
		do {
			System.out.println("**********************Menu*************************");
			System.out.println("1-Add user\n" + "2-remove user\n" + "3-Transaction\n" + "4-check share stock mareket");
			System.out.print("select choice:-> ");
			key = sc.nextInt();

			switch (key) {
			case 1:
				addusers();

				break;
			case 2:
				removeuser();
				break;

			case 3:
				transactions();
				break;
			case 4:
				StockOperations.Displaystock();
				break;

			default:
				break;
			}
		} while (key != 5);
	}

	public static void transactions() throws JsonParseException, JsonMappingException, IOException {
		int key;
		do {
			System.out.println();
			System.out.println("**************Transaction**************");
			System.out.println("1-Buy Shares\n" + "2-Sale Shares\n" + "3-user Log\n" + "4-Stock Menu");
			System.out.print("enter choice: ");
			key = sc.nextInt();
			switch (key) {
			case 1:
				buy();
				break;
			case 2:
				sell();
				break;
			case 3:
				printreport();
				break;
			case 4:
				StockOperations.Displaystock();
				break;
			default:
				break;
			}
		} while (key != 5);

	}

	private static void addusers() throws JsonParseException, JsonMappingException, IOException {
		List<StockUser> newuser = StockControl.readusers();

		StockUser newentry = new StockUser();

		System.out.print("enter user name: ");
		newentry.setUsername(sc.next());
		System.out.println();
		newentry.setShare(0);
		newuser.add(newentry);
		StockControl.writeusers(newuser);

	}

	private static void removeuser() throws JsonParseException, JsonMappingException, IOException {
		List<StockUser> user = StockControl.readusers();
		System.out.println();
		System.out.print("enput user name: ");
		String inputusername = sc.next();
		System.out.println();
		boolean find = false;
		for (StockUser stockUser : user) {
			if (stockUser.getUsername().equalsIgnoreCase(inputusername)) {
				find = true;
				if (stockUser.getShare() == 0) {
					user.remove(stockUser);
					System.out.println("removed successfully....");
				} else {
					System.out.println("sale all shares then remove");
				}

			}
		}
		if (!find) {
			System.out.println("not in the list");
			System.out.println();
		}
		StockControl.writeusers(user);
	}

	private static void buy() throws JsonParseException, JsonMappingException, IOException {

		StockOperations.Displaystock();
		System.out.println("user name");
		String username = sc.next();
		List<StockUser> user = StockControl.readusers();
		for (StockUser stockUser : user) {
			if (stockUser.getUsername().equalsIgnoreCase(username)) {
				System.out.println("enter company symbol");
				String inputsymbol = sc.next();
				String spath = StockOperations.spath;
				List<stockmodel> list = StockControl.readStock(spath);
				for (stockmodel stockmodel : list) {
					if (stockmodel.companysymbol.equals(inputsymbol)) {
						System.out.println("welcome to " + stockmodel.companyname);
						System.out.println("availabe Share is: " + stockmodel.companyavailableshare);
						System.out.println("price per share is: " + stockmodel.shareprice);

						System.out.println("no. of share you want?");
						int getshare = sc.nextInt();

						System.out.println("your buy" + getshare + " share at " + getshare * stockmodel.shareprice);
						stockmodel.setCompanyavailableshare(stockmodel.companyavailableshare - getshare);
						System.out.println();
						stockUser.setShare(getshare + stockUser.getShare());
						Transaction(stockUser, stockmodel, "buy");
					}
				}
				StockControl.writeusers(user);
				StockControl.writeStock(list);

			} else {
				System.out.println("your are not authorised user\nplease register your self....");
			}
		}

	}

	public static void Transaction(StockUser stockUser, stockmodel stockmodel, String status)
			throws JsonParseException, JsonMappingException, IOException {
		// DateTimeFormatter dtf = DateTimeFormatter.ofPattern("yyyy/MM/dd HH:mm:ss");
		Date date = new Date();
		List<TransactionLog> log = StockControl.readlog();
		TransactionLog transLog = new TransactionLog();
		transLog.setUsername(stockUser.getUsername());
		transLog.setCompanysymbol(stockmodel.getCompanysymbol());
		transLog.setCompanyname(stockmodel.getCompanyname());
		transLog.setCompanyshares(stockUser.getShare());
		transLog.setShareprice(stockUser.getShare() * stockmodel.getShareprice());
		transLog.setDate(date);
		switch (status) {
		case "sale":
			transLog.setTransction("sale");
			break;
		case "buy":
			transLog.setTransction("buy");
			break;
		default:
			break;
		}

		log.add(transLog);
		StockControl.writelog(log);

	}

	public static void printreport() throws JsonParseException, JsonMappingException, IOException {
		System.out.println("\n*******************User Log**********************");
		System.out.println("1-all transaction of users");
		boolean find = false;
		System.out.print("enter the name : ");
		String username = sc.next();
		System.out.println();
		List<TransactionLog> log = StockControl.readlog();
		for (TransactionLog transactionLog : log) {
			if (transactionLog.getUsername().equalsIgnoreCase(username)) {
				find = true;
				System.out.println(transactionLog.getUsername() + " " + transactionLog.getCompanyname() + " "
						+ transactionLog.getDate().toString() + " " + transactionLog.getTransction());
			}
		}
		if(!find) {
			System.out.println("no log found....");
		}
	}

	private static void sell() throws JsonParseException, JsonMappingException, IOException {
		StockOperations.Displaystock();
		System.out.println("username");
		String username = sc.next();
		List<StockUser> user = StockControl.readusers();
		for (StockUser stockUser : user) {
			if (stockUser.getUsername().equals(username)) {
				System.out.println("enter company symbol");
				String inputsymbol = sc.next();
				String spath = StockOperations.spath;
				List<stockmodel> list = StockControl.readStock(spath);
				for (stockmodel stockmodel : list) {
					if (stockmodel.companysymbol.equals(inputsymbol)) {
						System.out.println("enter share amount");
						int shares = sc.nextInt();
						System.out.println("your shares is : " + shares + "\n per share price: " + stockmodel.shareprice
								+ "\ntotl price is: " + shares * stockmodel.shareprice);
						System.out.println("sale successfully.....");
						stockmodel.setCompanyavailableshare(stockmodel.companyavailableshare + shares);
						stockUser.setShare(stockUser.getShare() - shares);
						Transaction(stockUser, stockmodel, "sale");
					}
				}
				StockControl.writeusers(user);
				StockControl.writeStock(list);

			}
		}

	}

}
